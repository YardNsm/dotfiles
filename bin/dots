#!/usr/bin/env bash

cd "$(dirname "${BASH_SOURCE[0]}")" \
  && source "../_setup/initializer.sh"

# ---------------------------------------------

run_install() {
  source "../install.sh" "$@"
}

run_topic() {
  if [[ -z "$1" ]]; then
    echo
    print_error "No topic provided"
    return 1
  fi

  install_specific_topic "$1"
}

list_topics() {
  print_title "Available topics"
  echo

  local list_runnable=0

  if [[ "$1" == "-r" ]] || [[ "$1" == "--runnable" ]]; then
    list_runnable=1
  fi

  # shellcheck disable=SC2207
  local topics

  if [[ $list_runnable -eq 0 ]]; then
    topics=( $(get_all_topics) )
  else
    topics=( $(get_runnable_topics) )
  fi

  for topic in "${topics[@]}"; do
    echo -ne "     $topic\\n"
  done
}

# ---------------------------------------------

print_help() {
  cat <<EOF

  Dotfiles maintenance

  Usage

    dots <command> [options]

  Commands

    run [topic]     Run the installation file of [topic]
    install         Run the installation script
    list            List all topics

  Options

    -r, --runnable          Show only runnable topics in 'run'
    -h, --help              Show help output

  Options are being passed to the install script
  when running 'install' command.
EOF
}

# ---------------------------------------------

main() {
  declare -r CMD=$1
  shift

  case "$CMD" in
    run )
      run_topic "$@"
      exit 0
      ;;
    install )
      export DOTS=1
      run_install "$@"
      exit 0
      ;;
    list )
      list_topics "$@"
      exit 0
      ;;
    -r | --runnable)
      list_runnable=1
      shift
      ;;
    "" | -h | --help)
      print_help
      exit 0
      ;;
    * )
      echo
      print_error "Unknown option $CMD";
      exit 1;
      ;;
  esac
}

main "$@"
